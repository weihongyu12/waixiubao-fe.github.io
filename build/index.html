<!DOCTYPE html>
<html lang="zh-cmn-Hans-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>构建流程 | 外修宝前端设计</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="适用于外修宝 Web 平台开发">
    <link rel="preload" href="/assets/css/0.styles.521d31f1.css" as="style"><link rel="preload" href="/assets/js/app.89ac3cdb.js" as="script"><link rel="preload" href="/assets/js/2.93040821.js" as="script"><link rel="preload" href="/assets/js/8.2c5b6339.js" as="script"><link rel="preload" href="/assets/js/6.25973203.js" as="script"><link rel="prefetch" href="/assets/js/10.e49e981c.js"><link rel="prefetch" href="/assets/js/11.b495c04e.js"><link rel="prefetch" href="/assets/js/12.07f8665b.js"><link rel="prefetch" href="/assets/js/13.61547fe8.js"><link rel="prefetch" href="/assets/js/14.aa9acf7e.js"><link rel="prefetch" href="/assets/js/15.e5af1fbf.js"><link rel="prefetch" href="/assets/js/16.ab30648d.js"><link rel="prefetch" href="/assets/js/17.4cc4d10e.js"><link rel="prefetch" href="/assets/js/18.b130ac6d.js"><link rel="prefetch" href="/assets/js/19.a70381fb.js"><link rel="prefetch" href="/assets/js/3.063211ca.js"><link rel="prefetch" href="/assets/js/4.1fb09417.js"><link rel="prefetch" href="/assets/js/5.fc185aab.js"><link rel="prefetch" href="/assets/js/7.7296c2cd.js"><link rel="prefetch" href="/assets/js/9.a42a62f8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.521d31f1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">外修宝前端设计</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/code/" class="nav-link">
  代码
</a></div><div class="nav-item"><a href="/build/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  构建流程
</a></div><div class="nav-item"><a href="/test/" class="nav-link">
  测试
</a></div><div class="nav-item"><a href="/features/" class="nav-link">
  功能设计
</a></div><div class="nav-item"><a href="/document/" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/restful-api/" class="nav-link">
  RESTful API
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/code/" class="nav-link">
  代码
</a></div><div class="nav-item"><a href="/build/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  构建流程
</a></div><div class="nav-item"><a href="/test/" class="nav-link">
  测试
</a></div><div class="nav-item"><a href="/features/" class="nav-link">
  功能设计
</a></div><div class="nav-item"><a href="/document/" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/restful-api/" class="nav-link">
  RESTful API
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>构建流程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/build/#手脚架" class="sidebar-link">手脚架</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/build/#构建命令" class="sidebar-link">构建命令</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/build/#构建工具" class="sidebar-link">构建工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/build/#webpack" class="sidebar-link">Webpack</a></li><li class="sidebar-sub-header"><a href="/build/#babel" class="sidebar-link">Babel</a></li><li class="sidebar-sub-header"><a href="/build/#css" class="sidebar-link">CSS</a></li></ul></li><li><a href="/build/#部署" class="sidebar-link">部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/build/#使用-history-模式的路由" class="sidebar-link">使用 history 模式的路由</a></li><li class="sidebar-sub-header"><a href="/build/#cors" class="sidebar-link">CORS</a></li><li class="sidebar-sub-header"><a href="/build/#pwa" class="sidebar-link">PWA</a></li></ul></li><li><a href="/build/#持续集成" class="sidebar-link">持续集成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/build/#持续集成流程" class="sidebar-link">持续集成流程</a></li><li class="sidebar-sub-header"><a href="/build/#commitlint" class="sidebar-link">Commitlint</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="构建流程"><a href="#构建流程" class="header-anchor">#</a> 构建流程</h1> <h2 id="手脚架"><a href="#手脚架" class="header-anchor">#</a> 手脚架</h2> <p>手脚架使用 <a href="https://cli.vuejs.org/" target="_blank" rel="noopener noreferrer">@vue/cli 4.x<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，启用自定义配置，配置流程如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 选择项目所需要的特性：</span>
<span class="token comment"># Babel（启用Babel转码）</span>
<span class="token comment"># PWA （启用PWA）</span>
<span class="token comment"># Router （安装vue-router）</span>
<span class="token comment"># Vuex （安装vuex）</span>
<span class="token comment"># CSS Pre-processors （使用CSS预处理器）</span>
<span class="token comment"># Linter / Formatter （使用静态检查/格式化）</span>
<span class="token comment"># Unit Testing （启用单元测试）</span>
<span class="token comment"># E2E Testing（启用E2E测试）</span>
Check the features needed <span class="token keyword">for</span> your project:
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Babel
 <span class="token punctuation">(</span> <span class="token punctuation">)</span> TypeScript
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Progressive Web App <span class="token punctuation">(</span>PWA<span class="token punctuation">)</span> Support
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Router
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Vuex
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> CSS Pre-processors
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Linter / Formatter
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Unit Testing
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> E2E Testing
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>除TypeScript必选</p></div> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 路由使用 history mode? (需要配置正式服务器) Y</span>
Use <span class="token function">history</span> mode <span class="token keyword">for</span> router? <span class="token punctuation">(</span>Requires proper server setup <span class="token keyword">for</span> index fallback <span class="token keyword">in</span> production<span class="token punctuation">)</span> <span class="token punctuation">(</span>Y/n<span class="token punctuation">)</span> Y
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>关于history mode的配置可以查看<a href="https://router.vuejs.org/guide/essentials/history-mode.html" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 选择CSS预处理器（PostCSS, Autoprefixer 和 CSS Modules 默认支持）：Sass/SCSS (with dart-sass)</span>
Pick a CSS pre-processor <span class="token punctuation">(</span>PostCSS, Autoprefixer and CSS Modules are supported by default<span class="token punctuation">)</span>:
<span class="token operator">&gt;</span> Sass/SCSS <span class="token punctuation">(</span>with dart-sass<span class="token punctuation">)</span>
  Sass/SCSS <span class="token punctuation">(</span>with node-sass<span class="token punctuation">)</span>
  Less
  Stylus
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>其他预处理器如果需要可以独立安装</p></div> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 选择linter / formatter配置：ESLint + Airbnb config</span>
Pick a linter / formatter config:
  ESLint with error prevention only
<span class="token operator">&gt;</span> ESLint + Airbnb config
  ESLint + Standard config
  ESLint + Prettier
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 选择其他lint功能：Lint on save, Lint and fix on commit</span>
Pick additional lint features:
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Lint on save
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Lint and fix on commit
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 选择单元测试方案：Mocha + Chai</span>
Pick a unit testing solution:
<span class="token operator">&gt;</span> Mocha + Chai
  Jest
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 选择E2E测试方案：Nightwatch</span>
Pick a E2E testing solution:
  Cypress <span class="token punctuation">(</span>Chrome only<span class="token punctuation">)</span>
<span class="token operator">&gt;</span> Nightwatch <span class="token punctuation">(</span>WebDriver-based<span class="token punctuation">)</span> 
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 选择浏览器以运行端到端测试：Chrome, Firefox</span>
Pick browsers to run end-to-end <span class="token builtin class-name">test</span> on
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Chrome
 <span class="token punctuation">(</span>*<span class="token punctuation">)</span> Firefox
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 在哪里放置Babel，PostCSS，ESLint等的配置：In dedicated config files（在专用配置文件中）</span>
Where <span class="token keyword">do</span> you prefer placing config <span class="token keyword">for</span> Babel, PostCSS, ESLint, etc.?
<span class="token operator">&gt;</span> In dedicated config files
  In package.json 
</code></pre></div><h2 id="构建命令"><a href="#构建命令" class="header-anchor">#</a> 构建命令</h2> <p>我们需要在<code>package.json</code>文件配置以下命令：</p> <div class="language-json extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue-cli-service build --modern&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>并通过此命令构建应用程序：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> build
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>包管理工具统一使用 <a href="https://yarnpkg.com/zh-Hans/" target="_blank" rel="noopener noreferrer">yarn<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，因为其速度更快。</p></div> <p>通过构建，我们会得到：</p> <ul><li><code>index.html</code> 会带有注入的资源和 resource hint</li> <li>第三方库会被分到一个独立包以便更好的缓存</li> <li>小于 10kb 的静态资源会被内联在 JavaScript 中</li> <li><code>public</code> 中的静态资源会被复制到输出目录中</li></ul> <p>我们使用了<code>--modern</code>参数 使用现代模式构建应用，为现代浏览器交付原生支持的 ES2015 代码，并生成一个兼容老浏览器的包用来自动回退。</p> <ul><li>现代版的包会通过 <code>&lt;script type=&quot;module&quot;&gt;</code> 在被支持的浏览器中加载；它们还会使用 <code>&lt;link rel=&quot;modulepreload&quot;&gt;</code> 进行预加载。</li> <li>旧版的包会通过 <code>&lt;script nomodule&gt;</code> 加载，并会被支持 ES modules 的浏览器忽略。</li> <li>一个针对 Safari 10 中 <code>&lt;script nomodule&gt;</code> 的修复会被自动注入。</li> <li>经过分析，现代版的包已经小了约 16%。在生产环境下，现代版的包通常都会表现出显著的解析速度和运算速度，从而改善应用的加载性能。</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>&lt;script type=&quot;module&quot;&gt;</code>需要配合始终开启的 CORS 进行加载。这意味着你的服务器必须返回诸如 <code>Access-Control-Allow-Origin: *</code>的有效的 CORS 头。如果你想要通过认证来获取脚本，可使用 <code>corsUseCredentials</code> 选项。</p> <p>同时，现代浏览器使用一段内联脚本来避免 Safari 10 重复加载脚本包，所以如果你在使用一套严格的 <code>CSP</code>，你需要这样显性地允许内联脚本：</p> <div class="language- extra-class"><pre class="language-text"><code>Content-Security-Policy: script-src 'self' 'sha256-4RS22DYeB7U14dra4KcQYxmwt5HkOInieXK1NUMBmQI='
</code></pre></div></div> <h2 id="构建工具"><a href="#构建工具" class="header-anchor">#</a> 构建工具</h2> <h3 id="webpack"><a href="#webpack" class="header-anchor">#</a> Webpack</h3> <p>Webpack 用于应用打包，主要工作文件转码、合并、切割、压缩等等，如果需要单独配置请查看 <a href="https://cli.vuejs.org/zh/guide/webpack.html" target="_blank" rel="noopener noreferrer">@vue/cli 文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="babel"><a href="#babel" class="header-anchor">#</a> Babel</h3> <p>Babel 是用于转化 ES6 至 ES5 的工具，生成的项目已经自带了 Babel 7</p> <p>可以使用 <a href="https://www.npmjs.com/package/babel-plugin-import" target="_blank" rel="noopener noreferrer">babel-plugin-import<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，按需加载需要的package，减少最后打包文件的大小</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>modules<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">&quot;import&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;libraryName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mand-mobile&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;libraryDirectory&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lib&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="css"><a href="#css" class="header-anchor">#</a> CSS</h3> <h4 id="css-预处理器"><a href="#css-预处理器" class="header-anchor">#</a> CSS 预处理器</h4> <p>CSS 预处理器默认选择 Sass，但是在项目进行中，如果需要其他的预处理器，可以独立进行安装</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Sass</span>
<span class="token function">yarn</span> <span class="token function">add</span> -D sass-loader sass

<span class="token comment"># Less</span>
<span class="token function">yarn</span> <span class="token function">add</span> -D less-loader <span class="token function">less</span>

<span class="token comment"># Stylus</span>
<span class="token function">yarn</span> <span class="token function">add</span> -D stylus-loader stylus
</code></pre></div><h4 id="postcss"><a href="#postcss" class="header-anchor">#</a> PostCSS</h4> <p>PostCSS 是一款 CSS 后处理器，主要用于为 CSS 加上浏览器兼容前缀</p> <p>在实际项目中，可根据具体情况使用 <a href="https://www.npmjs.com/package/postcss-pxtorem" target="_blank" rel="noopener noreferrer">postcss-pxtorem<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 把 <code>px</code> 单位转成 <code>rem</code>，从而实现不同设备下等比缩放的效果</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> pxtorem <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss-pxtorem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token function">pxtorem</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      rootValue<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
      propWhiteList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="部署"><a href="#部署" class="header-anchor">#</a> 部署</h2> <p>构建完成的文件会生成一个 <code>dist</code> 文件夹，将 <code>dist</code> 目录里构建的内容部署到任何静态文件服务器中，但要确保正确的 <code>baseUrl</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
   publicPath<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
    <span class="token operator">?</span> <span class="token string">'https://cdn.exmaple.com/'</span>
    <span class="token operator">:</span> <span class="token string">'/'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="使用-history-模式的路由"><a href="#使用-history-模式的路由" class="header-anchor">#</a> 使用 history 模式的路由</h3> <p>如果不想要很丑的 hash，我们可以用路由的 <a href="https://router.vuejs.org/zh/guide/essentials/history-mode.html" target="_blank" rel="noopener noreferrer">history 模式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这种模式充分利用 history.pushState API 来完成 URL 跳转而无须重新加载页面</p> <div class="language- extra-class"><pre class="language-text"><code># nginx.conf
location / {
  try_files $uri $uri/ /index.html;
}
</code></pre></div><h3 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h3> <p>前端静态内容是部署在与后端 API 不同的域名上，需要适当地配置 CORS</p> <p>以下是一个后端 API 的响应头示例</p> <div class="language- extra-class"><pre class="language-text"><code>Access-Control-Allow-Origin: https://m.waixiubao.com
Access-Control-Allow-Methods: POST, GET, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Authenticate
Access-Control-Max-Age: 86400
Access-Control-Allow-Credentials: true
</code></pre></div><h3 id="pwa"><a href="#pwa" class="header-anchor">#</a> PWA</h3> <p>使用了 PWA 插件，应用必须架设在 HTTPS 上，这样 Service Worker 才能被正确注册</p> <h2 id="持续集成"><a href="#持续集成" class="header-anchor">#</a> 持续集成</h2> <p>持续集成的主要工作是：</p> <ul><li>使用 Git 推送到 Gitlab 仓库（会运行静态检查）</li> <li>构建应用</li> <li>运行单元测试</li> <li>部署应用和相关文档到远程服务器</li></ul> <p>可以使用 Gitlab CI 进行相关工作</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># .gitlab-ci.yml</span>
build site<span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>lts
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> yarn install <span class="token punctuation">-</span><span class="token punctuation">-</span>frozen<span class="token punctuation">-</span>lockfile
    <span class="token punctuation">-</span> yarn build
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">expire_in</span><span class="token punctuation">:</span> 1 week
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> dist

unit test<span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>lts
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> yarn install <span class="token punctuation">-</span><span class="token punctuation">-</span>frozen<span class="token punctuation">-</span>lockfile
    <span class="token punctuation">-</span> yarn test<span class="token punctuation">:</span>unit

e2e test<span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span>lts
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> apt<span class="token punctuation">-</span>get update
    <span class="token punctuation">-</span> apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>yq libnss3 unzip openjdk<span class="token punctuation">-</span>8<span class="token punctuation">-</span>jre<span class="token punctuation">-</span>headless xvfb libxi6 libgconf<span class="token punctuation">-</span>2<span class="token punctuation">-</span><span class="token number">4</span>
    <span class="token punctuation">-</span> wget https<span class="token punctuation">:</span>//dl.google.com/linux/direct/google<span class="token punctuation">-</span>chrome<span class="token punctuation">-</span>stable_current_amd64.deb
    <span class="token punctuation">-</span> curl <span class="token punctuation">-</span>sS <span class="token punctuation">-</span>o <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//dl.google.com/linux/linux_signing_key.pub <span class="token punctuation">|</span> apt<span class="token punctuation">-</span>key add <span class="token punctuation">-</span>
    <span class="token punctuation">-</span> apt install <span class="token punctuation">-</span>y ./google<span class="token punctuation">-</span>chrome<span class="token punctuation">-</span>stable_current_amd64.deb
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> yarn install <span class="token punctuation">-</span><span class="token punctuation">-</span>frozen<span class="token punctuation">-</span>lockfile
    <span class="token punctuation">-</span> yarn test<span class="token punctuation">:</span>e2e

<span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache rsync openssh
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p ~/.ssh
    <span class="token punctuation">-</span> echo &quot;$SSH_PRIVATE_KEY&quot; <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> ~/.ssh/id_dsa
    <span class="token punctuation">-</span> chmod 600 ~/.ssh/id_dsa
    <span class="token punctuation">-</span> echo <span class="token punctuation">-</span>e &quot;Host <span class="token important">*\n\tStrictHostKeyChecking</span> no\n\n&quot; <span class="token punctuation">&gt;</span> ~/.ssh/config
    <span class="token punctuation">-</span> rsync <span class="token punctuation">-</span>rav <span class="token punctuation">-</span><span class="token punctuation">-</span>delete $LOCAL_PATH $USERNAME@$HOST_PATH
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果依赖安装过慢可以使用<a href="https://developer.aliyun.com/mirror" target="_blank" rel="noopener noreferrer">阿里云镜像<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <h3 id="持续集成流程"><a href="#持续集成流程" class="header-anchor">#</a> 持续集成流程</h3> <p><img src="/assets/img/ci.6e79138d.svg" alt="CI"></p> <ul><li><strong>编写代码：</strong> 包括功能代码、相关测试和文档</li> <li><strong>ESLint 检查：</strong> 代码是否通过 ESLint 检查</li> <li><strong>Commitlint 检查：</strong> Commit Message 是否符合规范</li> <li><strong>提交 MR：</strong></li> <li><strong>触发 CI 自动化测试：</strong> <ul><li>代码风格检查是否符合规范</li> <li>应用是否构建完成</li> <li>是否通过单元测试</li> <li>单元测试覆盖率是否达标</li></ul></li> <li><strong>Code Review：</strong> 至少经过一名高级工程师 Review</li> <li><strong>合并到主分支：</strong> 将进行第二轮 CI 自动化测试</li></ul> <h3 id="commitlint"><a href="#commitlint" class="header-anchor">#</a> Commitlint</h3> <p>为了方便追踪历史记录，并生成响应的 Changelog，建议使用 Commitlint 对commit message 进行校验</p> <h4 id="安装及配置"><a href="#安装及配置" class="header-anchor">#</a> 安装及配置</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> yorkie @commitlint/cli @commitlint/config-conventional -D
</code></pre></div><div class="language-json extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;gitHooks&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;commit-msg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;commitlint -E HUSKY_GIT_PARAMS&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// commitlint.config.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">extends</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@commitlint/config-conventional'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  rules<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">'type-enum'</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token string">'always'</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token string">'build'</span><span class="token punctuation">,</span>
        <span class="token string">'ci'</span><span class="token punctuation">,</span>
        <span class="token string">'chore'</span><span class="token punctuation">,</span>
        <span class="token string">'docs'</span><span class="token punctuation">,</span>
        <span class="token string">'feat'</span><span class="token punctuation">,</span>
        <span class="token string">'fix'</span><span class="token punctuation">,</span>
        <span class="token string">'perf'</span><span class="token punctuation">,</span>
        <span class="token string">'refactor'</span><span class="token punctuation">,</span>
        <span class="token string">'revert'</span><span class="token punctuation">,</span>
        <span class="token string">'style'</span><span class="token punctuation">,</span>
        <span class="token string">'test'</span><span class="token punctuation">,</span>
        <span class="token string">'improvement'</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h4> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>参考 <a href="https://www.conventionalcommits.org/zh/" target="_blank" rel="noopener noreferrer">Conventional Commits<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <p>Commit Message 信息格式统一如下：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;type&gt;[optional scope]: &lt;description&gt;

[optional body]

[optional footer]
</code></pre></div><p>例如</p> <div class="language- extra-class"><pre class="language-text"><code>fix(core): correct minor typos in code

see the issue for details on the typos fixed

close #12
</code></pre></div><h5 id="type"><a href="#type" class="header-anchor">#</a> type</h5> <p>type用于说明 commit 的类别，只允许使用下面标识：</p> <ul><li>build: 构建过程或辅助工具的变动</li> <li>ci: 对CI配置文件和脚本的更改</li> <li>chore: 其他的辅助更改</li> <li>docs: 文档更改</li> <li>feat: 新功能</li> <li>fix: bug 修复</li> <li>perf: 改进性能的代码更改</li> <li>refactor: 重构（即不是新增功能，也不是修改bug的代码变动）</li> <li>revert: commit 回滚</li> <li>style: 格式（不影响代码运行的变动）</li> <li>test: 测试代码的变动</li> <li>improvement: 功能改进或优化</li></ul> <h6 id="revert"><a href="#revert" class="header-anchor">#</a> revert</h6> <p>如果当前 Commit 用于撤销以前的 Commit，则必须以 <code>revert:</code> 开头，后面跟着被撤销 Commit Message</p> <p>Body 部分的格式是固定的，必须写成<code>This reverts commit &lt;hash&gt;.</code>，其中的hash是被撤销 Commit 的 SHA 标识符</p> <p>比如</p> <div class="language- extra-class"><pre class="language-text"><code>revert: fix(core): correct minor typos in code

This reverts commit 667ecc1654a317a13331b17617d973392f415f02.
</code></pre></div><h5 id="scope"><a href="#scope" class="header-anchor">#</a> scope</h5> <p>可选，scope 用于说明 Commit 影响的范围</p> <h5 id="subject"><a href="#subject" class="header-anchor">#</a> subject</h5> <p>subject 是 Commit 目的的简短描述，不超过50个字符</p> <h5 id="body"><a href="#body" class="header-anchor">#</a> body</h5> <p>可选，body 部分是对本次 Commit 的详细描述，可以分成多行</p> <h5 id="footer"><a href="#footer" class="header-anchor">#</a> footer</h5> <p>可选，只用于两种情况</p> <h6 id="不兼容变动"><a href="#不兼容变动" class="header-anchor">#</a> 不兼容变动</h6> <p>如果当前代码与上一个版本不兼容，则 footer 部分以 BREAKING CHANGE 开头，后面是对变动的描述、以及变动理由和迁移方法</p> <div class="language- extra-class"><pre class="language-text"><code>BREAKING CHANGE: isolate scope bindings definition has changed.

  To migrate the code follow the example below:

  Before:

  scope: {
    myAttr: 'attribute',
  }

  After:

  scope: {
    myAttr: '@',
  }

  The removed `inject` wasn't generaly useful for directives so there should be no code using it.
</code></pre></div><h6 id="关闭-issue"><a href="#关闭-issue" class="header-anchor">#</a> 关闭 Issue</h6> <p>如果当前 Commit 针对某个 Issue，那么可以在 footer 部分关闭这个 Issue</p> <div class="language- extra-class"><pre class="language-text"><code>Close #234
</code></pre></div><p>也可以一次关闭多个 issue 。</p> <div class="language- extra-class"><pre class="language-text"><code>Close #123, #245, #992
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>理论上，每次提交都应该有一个明确的 Issue</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/1/2020, 4:35:59 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.89ac3cdb.js" defer></script><script src="/assets/js/2.93040821.js" defer></script><script src="/assets/js/8.2c5b6339.js" defer></script><script src="/assets/js/6.25973203.js" defer></script>
  </body>
</html>
